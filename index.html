<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SST Report Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1e40af;
      --secondary: #60a5fa;
      --text-dark: #1f2937;
      --text-light: #4b5563;
      --bg-light: #f3f4f6;
      --white: #ffffff;
      --border: #e5e7eb;
    }

    * {
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }

    body {
      margin: 0;
      background-color: var(--bg-light);
      color: var(--text-dark);
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .wrap {
      max-width: 1200px;
      margin: auto;
      padding: 16px 16px 40px;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin: 8px 0 24px;
      text-align: center;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    @media (min-width: 960px) {
      .grid {
        grid-template-columns: 420px 1fr;
      }
    }

    .card {
      background-color: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .card h2 {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
      padding: 16px 20px;
      background-color: var(--bg-light);
      border-bottom: 1px solid var(--border);
    }

    .card .body {
      padding: 20px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-top: 14px;
      margin-bottom: 6px;
      color: var(--text-light);
    }

    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    
    input[readonly], textarea[readonly] {
      background-color: #f0f0f0;
      cursor: not-allowed;
      border-color: #e5e7eb;
    }

    input:not([readonly]):focus, textarea:not([readonly]):focus, select:focus {
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.25);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .row .input-container {
      position: relative;
    }

    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: var(--white);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .suggestions div {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
    }

    .suggestions div:hover {
      background-color: var(--bg-light);
    }

    .btn {
      display: inline-block;
      background-color: var(--primary);
      color: var(--white);
      border: none;
      padding: 14px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: background-color 0.3s, transform 0.1s;
    }

    .btn:hover {
      background-color: #1e3a8a;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-group {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* A4 preview */
    .a4-wrapper {
      padding: 20px;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }

    .a4 {
      width: 794px;
      min-height: 1123px;
      background-color: var(--white);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .report-content {
      border: 3px solid #000;
      padding: 30px;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
    }

    /* Mobile styles for the preview card */
    @media (max-width: 959px) {
      .card.preview-card .body {
        padding: 0;
      }
      .a4-wrapper {
        padding: 16px;
      }
      .a4 {
        margin: 0;
        min-height: unset;
        box-shadow: none;
        width: 100%;
        overflow-x: hidden;
        
        /* Scaling the A4 content to fit the screen */
        transform-origin: top center;
        transform: scale(calc((100vw - 32px) / 794)); /* 32px is total horizontal padding */
      }
    }

    .hdr {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      border-bottom: 2px solid #000;
      padding-bottom: 12px;
      margin-bottom: 20px;
    }

    .logo {
      width: 70px;
      height: 70px;
      object-fit: contain;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px;
    }

    .hdr-text {
      flex-grow: 1;
      text-align: left;
    }

    .hdr-text div {
      font-size: 14px;
      font-weight: 500;
    }

    .hdr-text .title {
      font-weight: bold;
      font-size: 20px;
      margin-top: 6px;
      color: var(--primary);
    }

    .hdr-info {
      font-size: 12px;
      border: 1px solid #000;
      padding: 8px 10px;
      border-radius: 8px;
      text-align: right;
    }

    .hdr-info div {
      white-space: nowrap;
    }

    .boxtbl {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 13px;
    }

    .boxtbl td {
      border: 1px solid #000;
      padding: 10px 8px;
      vertical-align: top;
    }

    .boxtbl .lbl {
      font-weight: 600;
      width: 180px;
      text-align: left;
      background-color: #f0f0f0;
    }

    .boxtbl td:nth-child(2), .boxtbl td:nth-child(4) {
      font-weight: 500;
      text-align: center;
    }

    .photos {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 767px) {
        .photos {
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
    }

    .ph {
      width: 100%;
      max-width: 350px;
      aspect-ratio: 1.5;
      border: 2px solid #000;
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      background-color: var(--bg-light);
    }
    
    .ph img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .photo-caption {
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      margin: 8px 0;
      color: var(--text-dark);
    }

    .muted {
      font-size: 14px;
      margin-top: 20px;
      text-align: left;
      font-weight: 500;
    }

    .foot {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
      font-size: 14px;
    }

    .foot div {
      border-top: 1px solid #000;
      padding-top: 8px;
      width: 45%;
      text-align: center;
    }

    .saved-reports {
      margin-top: 24px;
    }

    .saved-reports h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .saved-reports ul {
      list-style-type: none;
      padding: 0;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .saved-reports li {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .saved-reports li:last-child {
      border-bottom: none;
    }

    .saved-reports li:hover {
      background-color: var(--bg-light);
    }

    .saved-reports .delete-btn {
      color: #ef4444;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      opacity: 0.8;
    }

    .saved-reports .delete-btn:hover {
      opacity: 1;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>üß™ SST Report Generator (Single HTML)</h1>
    <div class="grid">
      <div class="card">
        <h2>‡§´‡§º‡•â‡§∞‡•ç‡§Æ ‡§≠‡§∞‡•á‡§Ç</h2>
        <div class="body">
          <div class="row">
            <div>
              <label>Company</label>
              <input id="company" value="WELLCOAT TECH" readonly/>
            </div>
            <div>
              <label>Logo (optional)</label>
              <input id="logo" type="file" accept="image/*"/>
            </div>
          </div>

          <label>Report Title</label>
          <input id="title" value="NEUTRAL SALT SPRAY TEST REPORT" readonly/>
          <label>Sub‚ÄëTitle</label>
          <input id="subtitle" value="(TEST CONDUCTED AS PER ASTM B 117)" readonly/>

          <div class="row">
            <div><label>DOC NO</label><input id="docNo" value="DOC NO:014" readonly/></div>
            <div><label>REV NO</label><input id="revNo" value="REV.NO:00" readonly/></div>
          </div>
          <div class="row">
            <div><label>REV DATE</label><input id="revDate" type="date" readonly/></div>
            <div><label>TC Date</label><input id="tcDate" readonly/></div>
          </div>
          
          <div class="row">
            <div><label>SST Tag No</label><input id="tag" value="39"/></div>
            <div><label>Production Batch</label><input id="batch" value="250710"/></div>
          </div>
          
          <div class="row">
            <div class="input-container">
              <label>Part No/Name</label>
              <input id="part" value="3871" list="partsList" autocomplete="off"/>
              <datalist id="partsList"></datalist>
            </div>
            <div class="input-container">
              <label>Customer Name</label>
              <input id="customer" value="BG FASTENING AND ENGINEERING" list="customersList" autocomplete="off"/>
              <datalist id="customersList"></datalist>
            </div>
          </div>
          
          <div class="row">
            <div><label>Coating System</label><input id="coatSys" value="Zinc Al. Flake Coating"/></div>
            <div>
              <label>Color</label>
              <input id="color" value="SILVER" />
            </div>
          </div>
          <div class="row">
            <div><label>Coating Process</label><input id="process" value="Dip spin coating"/></div>
            <div><label>No. of Coat</label><input id="coats" value="2 Base (GEOPERT500) | 1 Top (AQUAZINC)"/></div>
          </div>
          <div class="row">
            <div><label>Coating Thickness</label><input id="thick" value="8‚Äì12 MIC"/></div>
            <div><label>SST Equipment</label><input id="equip" value="Salt Spray Chamber"/></div>
          </div>
          <div class="row">
            <div><label>Capacity</label><input id="capacity" value=">= 450 L"/></div>
            <div><label>Water Type</label><input id="water" value="D.I. Water"/></div>
          </div>
          <div class="row">
            <div><label>Type of Salt</label><input id="salt" value="Lab, Grade NaCl, 5%"/></div>
            <div><label>Customer Requirement (Hrs)</label><input id="sstHrs" type="number" value="720" min="0" /></div>
          </div>
          
          <div>
              <label>Observation for Red Rust</label>
              <input id="obs" value="720 Hrs No red rust" />
          </div>

          <div class="row">
            <div><label>Loaded Date</label><input id="loadDate" value="2025-07-16" type="date"/></div>
            <div><label>Loaded Time</label><input id="loadTime" value="11:00" type="time" readonly/></div>
          </div>
          <div class="row">
            <div><label>Test Stop Date</label><input id="stopDate" value="2025-08-15" type="date" readonly/></div>
            <div><label>Test Stop Time</label><input id="stopTime" value="11:10" type="time" readonly/></div>
          </div>
          
          <div class="row">
            <div><label>No. of Samples</label><input id="samples" value="3"/></div>
            <div><label>Checked By</label><input id="checked" value="SAKSHI CHAVHAN"/></div>
          </div>
          <div class="row">
            <div><label>Approved By</label><input id="approved" value="ABHIJEET DHOKRAT"/></div>
          </div>
          <label>Remark</label>
          <textarea id="remark">Sample SST passed 720 Hrs. No red rust found.</textarea>
          
          <label>Sample Photo (Before)</label>
          <input id="before" type="file" accept="image/*"/>
          <label>Sample Photo (After)</label>
          <input id="after" type="file" accept="image/*"/>
          <br>
          <div class="btn-group">
            <button class="btn" id="btnPdf">Download PDF</button>
            <button class="btn" id="btnSave">Save Report</button>
            <button class="btn" id="btnClear">Clear Form</button>
          </div>
          <div style="font-size:12px; color:#6b7280; margin-top:10px;">
            **PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§™‡§∞, ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ë‡§ü‡•ã‡§Æ‡•à‡§ü‡§ø‡§ï‡§≤‡•Ä ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§**
          </div>
        </div>
        <div class="saved-reports">
          <h2>‡§∏‡•á‡§µ‡•ç‡§° ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏</h2>
          <div class="body">
            <ul id="reportsList">
              </ul>
          </div>
        </div>
      </div>

      <div class="card preview-card">
        <h2>‡§≤‡§æ‡§á‡§µ ‡§™‡•ç‡§∞‡•Ä‡§µ‡•ç‡§Ø‡•Ç (A4)</h2>
        <div class="body">
          <div id="preview" class="a4-wrapper">
            <div class="a4">
              <div class="report-content">
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Right-click and keyboard shortcuts are disabled
  document.addEventListener('contextmenu', event => event.preventDefault());
  document.addEventListener('keydown', event => {
    if (event.ctrlKey || event.metaKey) {
      if (event.key === 'c' || event.key === 'u' || event.key === 's' || event.key === 'i' || event.key === 'j') {
        event.preventDefault();
        alert('This action is disabled.');
      }
    }
  });

  const $ = (id) => document.getElementById(id);
  const state = { logo: "", before: "", after: "" };
  const inputIds = ['company', 'title', 'subtitle', 'docNo', 'revNo', 'revDate', 'tcDate', 'tag', 'batch', 'part', 'customer', 'coatSys', 'color', 'process', 'coats', 'thick', 'equip', 'capacity', 'water', 'salt', 'sstHrs', 'loadDate', 'loadTime', 'stopDate', 'stopTime', 'obs', 'samples', 'remark', 'checked', 'approved'];

  const defaultValues = {
    company: "WELLCOAT TECH",
    title: "NEUTRAL SALT SPRAY TEST REPORT",
    subtitle: "(TEST CONDUCTED AS PER ASTM B 117)",
    docNo: "DOC NO:014",
    revNo: "REV.NO:00",
    revDate: "2025-09-04",
    tcDate: "04.09.2025",
    tag: "39",
    batch: "250710",
    part: "3871",
    customer: "BG FASTENING AND ENGINEERING",
    coatSys: "Zinc Al. Flake Coating",
    color: "SILVER",
    process: "Dip spin coating",
    coats: "2 Base (GEOPERT500) | 1 Top (AQUAZINC)",
    thick: "8‚Äì12 MIC",
    equip: "Salt Spray Chamber",
    capacity: ">= 450 L",
    water: "D.I. Water",
    salt: "Lab, Grade NaCl, 5%",
    sstHrs: "720",
    loadDate: "2025-07-16",
    loadTime: "11:00",
    stopDate: "2025-08-15",
    stopTime: "11:10",
    obs: "720 Hrs No red rust",
    samples: "3",
    remark: "Sample SST passed 720 Hrs. No red rust found.",
    checked: "SAKSHI CHAVHAN",
    approved: "ABHIJEET DHOKRAT"
  };

  // Set default value for revDate to the current date on load
  document.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    const formattedDate = `${String(today.getDate()).padStart(2, '0')}.${String(today.getMonth() + 1).padStart(2, '0')}.${today.getFullYear()}`;
    const formattedDateForInput = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    $('revDate').value = formattedDateForInput;
    $('tcDate').value = formattedDate;
    
    // Set default values from the object
    inputIds.forEach(id => {
      const el = $(id);
      if (el && defaultValues[id] !== undefined) {
        if (el.type === 'date' || el.type === 'time') {
          // Do nothing for date and time as they are handled above or automatically
        } else {
          el.value = defaultValues[id];
        }
      }
    });

    loadInitialReports();
    loadSuggestions();
    updateSuggestions();
    calculateStopDate();
    render();
  });
  
  let usedCustomers = new Set();
  let usedParts = new Set();
  let savedReports = [];

  function loadSuggestions() {
    const savedCustomers = JSON.parse(localStorage.getItem('sstCustomers') || '[]');
    const savedParts = JSON.parse(localStorage.getItem('sstParts') || '[]');
    savedCustomers.forEach(c => usedCustomers.add(c));
    savedParts.forEach(p => usedParts.add(p));
  }
  
  function updateSuggestions() {
    const customerDatalist = $('customersList');
    customerDatalist.innerHTML = '';
    usedCustomers.forEach(customer => {
      const option = document.createElement('option');
      option.value = customer;
      customerDatalist.appendChild(option);
    });
    
    const partDatalist = $('partsList');
    partDatalist.innerHTML = '';
    usedParts.forEach(part => {
      const option = document.createElement('option');
      option.value = part;
      partDatalist.appendChild(option);
    });
  }
  
  function calculateStopDate() {
    const loadDateStr = $('loadDate').value;
    const loadTimeStr = '11:00';
    const sstHours = parseInt($('sstHrs').value, 10);

    if (!loadDateStr || isNaN(sstHours)) {
      $('stopDate').value = '';
      return;
    }

    const [year, month, day] = loadDateStr.split('-').map(Number);
    const [hours, minutes] = loadTimeStr.split(':').map(Number);
    const startDate = new Date(year, month - 1, day, hours, minutes);

    const endDate = new Date(startDate.getTime() + sstHours * 60 * 60 * 1000);

    const endYear = endDate.getFullYear();
    const endMonth = String(endDate.getMonth() + 1).padStart(2, '0');
    const endDay = String(endDate.getDate()).padStart(2, '0');
    const newStopDate = `${endYear}-${endMonth}-${endDay}`;
    
    $('stopDate').value = newStopDate;
    $('tcDate').value = formatDate(newStopDate); // Update TC Date as well
  }

  function updateObsText() {
      const sstHours = $('sstHrs').value;
      if (sstHours) {
          $('obs').value = `${sstHours} Hrs No red rust`;
      } else {
          $('obs').value = '';
      }
      render();
  }

  function updateRemarkText() {
      const sstHours = $('sstHrs').value;
      if (sstHours) {
          $('remark').value = `Sample SST passed ${sstHours} Hrs. No red rust found.`;
      } else {
          $('remark').value = '';
      }
      render();
  }

  function updateCoatInfo() {
      const color = $('color').value.trim().toUpperCase();
      const coatsInput = $('coats');
      if (color === "SILVER") {
          coatsInput.value = "2 Base (GEOPERT500) | 1 Top (AQUAZINC)";
      } else if (color === "BLACK") {
          coatsInput.value = "2 Base (ZINTEC 300 HPA) | 2 Top (TECHDIP HL)";
      }
      render();
  }

  function fileToDataURL(file) {
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = (e) => res(e.target.result);
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });
  }
  
  function getFormData() {
    const data = {};
    inputIds.forEach(id => {
      data[id] = $(id).value;
    });
    data.logo = state.logo;
    data.before = state.before;
    data.after = state.after;
    return data;
  }

  function setFormData(data) {
    inputIds.forEach(id => {
      const el = $(id);
      if (el) el.value = data[id] || '';
    });
    state.logo = data.logo || "";
    state.before = data.before || "";
    state.after = data.after || "";
    render();
  }

  function saveReport() {
    const reportData = getFormData();
    reportData.id = Date.now();
    savedReports.push(reportData);
    localStorage.setItem('sstSavedReports', JSON.stringify(savedReports));
    alert('Report saved successfully!');
    renderReportsList();
  }

  function loadReport(id) {
    const report = savedReports.find(r => r.id === id);
    if (report) {
      setFormData(report);
      alert('Report loaded successfully!');
    }
  }

  function deleteReport(id) {
    savedReports = savedReports.filter(r => r.id !== id);
    localStorage.setItem('sstSavedReports', JSON.stringify(savedReports));
    renderReportsList();
    alert('Report deleted successfully.');
  }

  function renderReportsList() {
    const reportsListEl = $('reportsList');
    reportsListEl.innerHTML = '';
    if (savedReports.length === 0) {
      reportsListEl.innerHTML = '<li style="justify-content:center;color:#6b7280;">‡§ï‡•ã‡§à ‡§∏‡•á‡§µ‡•ç‡§° ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</li>';
      return;
    }
    savedReports.forEach(report => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span onclick="loadReport(${report.id})">
          ${report.part || 'No Part'} - ${report.customer || 'No Customer'}
        </span>
        <span class="delete-btn" onclick="deleteReport(${report.id})">üóëÔ∏è</span>
      `;
      reportsListEl.appendChild(li);
    });
  }
  
  function loadInitialReports() {
    const storedReports = localStorage.getItem('sstSavedReports');
    if (storedReports) {
      savedReports = JSON.parse(storedReports);
    }
    renderReportsList();
  }

  function showReminder() {
      const stopDate = $('stopDate').value;
      const stopTime = $('stopTime').value;
      
      const formattedDate = formatDate(stopDate);
      const formattedTime = formatTime(stopTime);

      if (formattedDate && formattedTime) {
          alert(`Reminder: ‡§Ø‡§π ‡§™‡§æ‡§∞‡•ç‡§ü ${formattedDate} ‡§ï‡•ã ${formattedTime} ‡§™‡§∞ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ‡•§`);
      } else {
          alert("‡§∞‡§ø‡§Æ‡§æ‡§á‡§Ç‡§°‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•á‡§∏‡•ç‡§ü ‡§∏‡•ç‡§ü‡•â‡§™ ‡§°‡•á‡§ü ‡§î‡§∞ ‡§ü‡§æ‡§á‡§Æ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§");
      }
  }

  const formElements = document.querySelectorAll('input, textarea');
  formElements.forEach(el => {
    if (el.type !== 'file' && !el.readOnly) {
      el.addEventListener('input', render);
    }
  });

  $('logo').addEventListener('change', async e => {
    const f = e.target.files?.[0];
    if (f) state.logo = await fileToDataURL(f);
    render();
  });
  $('before').addEventListener('change', async e => {
    const f = e.target.files?.[0];
    if (f) state.before = await fileToDataURL(f);
    render();
  });
  $('after').addEventListener('change', async e => {
    const f = e.target.files?.[0];
    if (f) state.after = await fileToDataURL(f);
    render();
  });

  function render() {
    const P = $('preview').querySelector('.report-content');
    const v = (id) => $(id).value;
    
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `${day}.${month}.${year}`;
    }
    
    function formatTime(timeStr) {
      if (!timeStr) return '';
      const [hours, minutes] = timeStr.split(':');
      const hour = parseInt(hours, 10);
      const ampm = hour >= 12 ? 'pm' : 'am';
      const formattedHour = hour % 12 === 0 ? 12 : hour % 12;
      return `${String(formattedHour).padStart(2, '0')}:${minutes} ${ampm}`;
    }
    
    P.innerHTML = `
      <div class="hdr">
        <div style="display:flex;gap:15px;align-items:center;">
          ${state.logo ? `<img class="logo" src="${state.logo}" alt="Company Logo">` : `<div class="logo" style="display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text-light);background-color:var(--bg-light);">LOGO</div>`}
          <div class="hdr-text">
            <div style="font-size:22px;font-weight:700;color:var(--primary);">${v('company')}</div>
            <div class="title">${v('title')}</div>
            <div style="font-size:14px;font-weight:500;color:var(--text-light);">${v('subtitle')}</div>
          </div>
        </div>
        <table style="font-size:12px;border-collapse:collapse;border:1px solid #000;height:min-content;margin-top:10px;font-weight:500;">
          <tr><td style="border:1px solid #000;padding:5px 8px;">${v('docNo')}</td></tr>
          <tr><td style="border:1px solid #000;padding:5px 8px;">${v('revNo')}</td></tr>
          <tr><td style="border:1px solid #000;padding:5px 8px;">REV.DATE: ${v('revDate') ? formatDate(v('revDate')) : 'N/A'}</td></tr>
        </table>
      </div>

      <table class="boxtbl">
        ${row('SST Tag No', v('tag'), 'PRODUCTION BATCH', v('batch'))}
        ${row('TC Date', v('tcDate'), 'Part No/Name', v('part'))}
        ${row('Customer Name', v('customer'), 'Color', v('color'))}
        ${row('Coating System', v('coatSys'), 'Coating Process', v('process'))}
        ${row('No. of Coat', v('coats'), 'Coating Thickness', v('thick'))}
        ${row('SST Equipment', v('equip'), 'Corrosion Test Apparatus Capacity', v('capacity'))}
        ${row('Water type', v('water'), 'Type of salt', v('salt'))}
        ${row('Component loaded for SST on (Date & time)', formatDate(v('loadDate')) + ' ' + formatTime(v('loadTime')), 'Customer requirement for SST', v('sstHrs') + ' Hrs')}
        ${row('Test Stop & Observation Date & Time', formatDate(v('stopDate')) + ' ' + formatTime(v('stopTime')), 'Observation for Red Rust', v('obs'))}
        <tr><td class="lbl">No. of Samples for SST</td><td colspan="3" style="text-align:center;">${v('samples')}</td></tr>
      </table>

      <div class="photos">
        <div>
          <div class="photo-caption">SAMPLE PHOTO BEFORE SST</div>
          <div class="ph">${state.before ? `<img src="${state.before}" alt="Sample before SST">` : 'No image'}</div>
        </div>
        <div>
          <div class="photo-caption">SAMPLE PHOTO AFTER SST</div>
          <div class="ph">${state.after ? `<img src="${state.after}" alt="Sample after SST">` : 'No image'}</div>
        </div>
      </div>

      <div class="muted">Remark: ${v('remark')}</div>
      <div class="foot">
        <div>Checked by: <br><b>${v('checked')}</b></div>
        <div>Approved by: <br><b>${v('approved')}</b></div>
      </div>
    `;
  }

  function row(a, b, c, d) {
    return `<tr><td class="lbl">${a}</td><td style="text-align:center">${b || ''}</td><td class="lbl">${c}</td><td style="text-align:center">${d || ''}</td></tr>`;
  }

  function clearForm() {
    inputIds.forEach(id => {
      const el = $(id);
      if (el && !el.readOnly) {
        el.value = defaultValues[id] || '';
      }
    });
    $('logo').value = '';
    $('before').value = '';
    $('after').value = '';
    state.logo = state.before = state.after = "";
    
    // Resetting readonly fields as well, just in case
    $('company').value = defaultValues.company;
    $('title').value = defaultValues.title;
    $('subtitle').value = defaultValues.subtitle;
    $('docNo').value = defaultValues.docNo;
    $('revNo').value = defaultValues.revNo;
    const today = new Date();
    const formattedDateForInput = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    const formattedDate = `${String(today.getDate()).padStart(2, '0')}.${String(today.getMonth() + 1).padStart(2, '0')}.${today.getFullYear()}`;
    $('revDate').value = formattedDateForInput;
    $('tcDate').value = formattedDate;

    render();
  }

  $('btnPdf').addEventListener('click', async (e) => {
    e.preventDefault();
    
    saveReport();

    const customerValue = $('customer').value.trim();
    const partValue = $('part').value.trim();
    if (customerValue) {
      usedCustomers.add(customerValue);
      localStorage.setItem('sstCustomers', JSON.stringify(Array.from(usedCustomers)));
    }
    if (partValue) {
      usedParts.add(partValue);
      localStorage.setItem('sstParts', JSON.stringify(Array.from(usedParts)));
    }
    updateSuggestions();

    const tempEl = document.createElement('div');
    tempEl.classList.add('a4');
    tempEl.style.position = 'absolute';
    tempEl.style.left = '-9999px';
    tempEl.style.top = '-9999px';
    document.body.appendChild(tempEl);

    const v = (id) => $(id).value;
    
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `${day}.${month}.${year}`;
    }
    
    function formatTime(timeStr) {
      if (!timeStr) return '';
      const [hours, minutes] = timeStr.split(':');
      const hour = parseInt(hours, 10);
      const ampm = hour >= 12 ? 'pm' : 'am';
      const formattedHour = hour % 12 === 0 ? 12 : hour % 12;
      return `${String(formattedHour).padStart(2, '0')}:${minutes} ${ampm}`;
    }

    tempEl.innerHTML = `
      <div class="report-content">
        <div class="hdr">
          <div style="display:flex;gap:15px;align-items:center;">
            ${state.logo ? `<img class="logo" src="${state.logo}" alt="Company Logo">` : `<div class="logo" style="display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text-light);background-color:var(--bg-light);">LOGO</div>`}
            <div class="hdr-text">
              <div style="font-size:22px;font-weight:700;color:var(--primary);">${v('company')}</div>
              <div class="title">${v('title')}</div>
              <div style="font-size:14px;font-weight:500;color:var(--text-light);">${v('subtitle')}</div>
            </div>
          </div>
          <table style="font-size:12px;border-collapse:collapse;border:1px solid #000;height:min-content;margin-top:10px;font-weight:500;">
            <tr><td style="border:1px solid #000;padding:5px 8px;">${v('docNo')}</td></tr>
            <tr><td style="border:1px solid #000;padding:5px 8px;">${v('revNo')}</td></tr>
            <tr><td style="border:1px solid #000;padding:5px 8px;">REV.DATE: ${v('revDate') ? formatDate(v('revDate')) : 'N/A'}</td></tr>
          </table>
        </div>
        <table class="boxtbl">
          ${row('SST Tag No', v('tag'), 'PRODUCTION BATCH', v('batch'))}
          ${row('TC Date', v('tcDate'), 'Part No/Name', v('part'))}
          ${row('Customer Name', v('customer'), 'Color', v('color'))}
          ${row('Coating System', v('coatSys'), 'Coating Process', v('process'))}
          ${row('No. of Coat', v('coats'), 'Coating Thickness', v('thick'))}
          ${row('SST Equipment', v('equip'), 'Corrosion Test Apparatus Capacity', v('capacity'))}
          ${row('Water type', v('water'), 'Type of salt', v('salt'))}
          ${row('Component loaded for SST on (Date & time)', formatDate(v('loadDate')) + ' ' + formatTime(v('loadTime')), 'Customer requirement for SST', v('sstHrs') + ' Hrs')}
          ${row('Test Stop & Observation Date & Time', formatDate(v('stopDate')) + ' ' + formatTime(v('stopTime')), 'Observation for Red Rust', v('obs'))}
          <tr><td class="lbl">No. of Samples for SST</td><td colspan="3" style="text-align:center;">${v('samples')}</td></tr>
        </table>
        <div class="photos">
          <div>
            <div class="photo-caption">SAMPLE PHOTO BEFORE SST</div>
            <div class="ph">${state.before ? `<img src="${state.before}" alt="Sample before SST">` : 'No image'}</div>
          </div>
          <div>
            <div class="photo-caption">SAMPLE PHOTO AFTER SST</div>
            <div class="ph">${state.after ? `<img src="${state.after}" alt="Sample after SST">` : 'No image'}</div>
          </div>
        </div>
        <div class="muted">Remark: ${v('remark')}</div>
        <div class="foot">
          <div>Checked by: <br><b>${v('checked')}</b></div>
          <div>Approved by: <br><b>${v('approved')}</b></div>
        </div>
      </div>
    `;

    function row(a, b, c, d) {
      return `<tr><td class="lbl">${a}</td><td style="text-align:center">${b || ''}</td><td class="lbl">${c}</td><td style="text-align:center">${d || ''}</td></tr>`;
    }
    
    const canvas = await html2canvas(tempEl, {
      scale: 1.5,
      backgroundColor: '#fff'
    });
    
    document.body.removeChild(tempEl);

    const img = canvas.toDataURL('image/jpeg', 0.7);
    const { jsPDF } = window.jspdf;
    
    const pdf = new jsPDF({ 
      unit: 'pt', 
      format: 'a4',
      orientation: 'portrait'
    });
    
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    
    const margin = 20;
    const imgW = pageW - 2 * margin;
    const imgH = imgW * (canvas.height / canvas.width);
    
    let heightLeft = imgH;
    let position = margin;
    
    pdf.addImage(img, 'JPEG', margin, position, imgW, imgH);
    heightLeft -= pageH;
    
    while (heightLeft > 0) {
      position = heightLeft - imgH + margin;
      pdf.addPage();
      pdf.addImage(img, 'JPEG', margin, position, imgW, imgH);
      heightLeft -= pageH;
    }

    const customerName = $('customer').value.trim() || 'Customer';
    const partNo = $('part').value.trim() || 'PartNo';
    const filename = `${customerName.replace(/[^a-z0-9]/gi, '_')}_${partNo.replace(/[^a-z0-9]/gi, '_')}.pdf`;

    pdf.save(filename);

    alert('PDF report has been downloaded to your default Downloads folder.');
  });

  $('btnSave').addEventListener('click', (e) => {
    e.preventDefault();
    saveReport();
    showReminder();
  });

  $('btnClear').addEventListener('click', clearForm);
  
  window.loadReport = loadReport;
  window.deleteReport = deleteReport;

  loadInitialReports();
  loadSuggestions();
  updateSuggestions();
  
  $('customer').addEventListener('input', updateSuggestions);
  $('part').addEventListener('input', updateSuggestions);
  
  $('loadDate').addEventListener('change', () => { calculateStopDate(); render(); });
  $('sstHrs').addEventListener('input', () => { calculateStopDate(); updateObsText(); updateRemarkText(); });
  $('color').addEventListener('input', updateCoatInfo);
  
  calculateStopDate();
  render();
</script>
</body>
</html>